<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Investment Portfolio Tracker</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .last-updated {
        opacity: 0.9;
        font-size: 0.9em;
      }

      .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        padding: 30px;
        background: #f8f9fa;
      }

      .summary-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .summary-card h3 {
        color: #333;
        margin-bottom: 15px;
      }

      .summary-card .value {
        font-size: 2.2em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .summary-card .gain-loss {
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 10px;
        margin-top: 0px;
      }

      .summary-card .invested-amount {
        font-size: 1em;
        color: #000;
        margin-top: 10px;
        font-weight: bold;
      }

      .positive {
        color: #4caf50;
      }
      .negative {
        color: #f44336;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }

      .close-modal {
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
      }

      .close-modal:hover {
        background: #da190b;
      }

      .transaction-list {
        display: grid;
        gap: 15px;
      }

      .transaction-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: #f9f9f9;
      }

      .transaction-card h4 {
        margin-bottom: 10px;
        color: #333;
      }

      .content {
        padding: 30px;
      }

      .section {
        margin-bottom: 40px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .section h2 {
        color: #333;
        font-size: 1.8em;
      }

      .btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: #45a049;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #f44336;
      }

      .btn-danger:hover {
        background: #da190b;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .table th,
      .table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
      }

      .table tr:hover {
        background: #f8f9fa;
      }

      /* Company name column styling */
      .table th:first-child,
      .table td:first-child {
        min-width: 200px;
        max-width: 300px;
      }

      .asset-name {
        font-weight: 600;
        color: #2196f3;
        cursor: pointer;
      }

      .asset-name:hover {
        text-decoration: underline;
      }

      /* Collapsible transaction styles */
      .arrow-icon {
        display: inline-block;
        margin-right: 8px;
        transition: transform 0.3s ease;
        font-size: 0.8em;
        color: #666;
        cursor: pointer;
      }

      .arrow-icon:hover {
        color: #2196f3;
      }

      .arrow-icon.expanded {
        transform: rotate(90deg);
      }

      .asset-name {
        cursor: pointer;
        color: #2196f3;
        text-decoration: none;
        font-weight: bold;
      }

      .asset-name:hover {
        text-decoration: underline;
      }

      .transaction-details {
        display: none;
        background: #f8f9fa;
        border-left: 3px solid #2196f3;
      }

      .transaction-details.show {
        display: table-row;
      }

      .transaction-details td {
        padding: 15px !important;
        border-top: none !important;
      }

      .transactions-table {
        width: 100%;
        margin: 0;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .transactions-table th,
      .transactions-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
        font-size: 0.9em;
      }

      .transactions-table th {
        background: #2196f3;
        color: white;
        font-weight: 600;
      }

      .transactions-table tr:nth-child(even) {
        background: #f9f9f9;
      }

      /* Action button styles */
      .action-btn {
        background: none;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
        margin: 0 5px;
        padding: 5px;
        border-radius: 3px;
        transition: background-color 0.2s ease;
      }

      .action-btn:hover {
        background-color: rgba(0, 0, 0, 0.1);
      }

      .edit-btn:hover {
        background-color: rgba(33, 150, 243, 0.1);
      }

      .delete-btn:hover {
        background-color: rgba(244, 67, 54, 0.1);
      }

      .form-container {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .form-container h3 {
        margin-bottom: 25px;
        margin-top: 0;
        color: #333;
        font-size: 1.5em;
        font-weight: 600;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
        position: relative;
      }

      .form-group label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }

      .form-group input {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1em;
        transition: border-color 0.3s ease;
      }

      .form-group select {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1em;
        transition: border-color 0.3s ease;
        background-color: white;
        cursor: pointer;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4caf50;
      }

      /* Date input placeholder styling */
      input[type="date"] {
        text-transform: uppercase;
      }

      /* Search Input with Icon Styles */
      .input-with-icon {
        position: relative;
        display: block;
        width: 100%;
      }

      .input-with-icon input {
        width: 100%;
        padding-right: 40px;
      }

      .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-size: 1.1em;
        pointer-events: none;
        z-index: 2;
      }

      .suggestions-dropdown {
        position: absolute;
        top: calc(100% + 2px);
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-top: 2px;
      }

      .suggestion-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .suggestion-item:hover {
        background-color: #f8f9fa;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-symbol {
        font-weight: 600;
        color: #2196f3;
      }

      .suggestion-name {
        color: #666;
        font-size: 0.9em;
        margin-left: 8px;
      }

      .suggestion-exchange {
        font-size: 0.8em;
        color: #999;
        background: #f0f0f0;
        padding: 2px 6px;
        border-radius: 3px;
      }

      .suggestion-item.loading {
        color: #666;
        font-style: italic;
        justify-content: center;
      }

      .suggestion-item.loading:hover {
        background-color: transparent;
        cursor: default;
      }

      .suggestion-item.no-results {
        color: #999;
        font-style: italic;
        justify-content: center;
      }

      .suggestion-item.no-results:hover {
        background-color: transparent;
        cursor: default;
      }

      .suggestion-item.error {
        color: #d32f2f;
        font-style: italic;
        justify-content: center;
      }

      .suggestion-item.error:hover {
        background-color: transparent;
        cursor: default;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .empty-state img {
        width: 100px;
        opacity: 0.5;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
          border-radius: 10px;
        }

        .summary {
          grid-template-columns: 1fr;
          padding: 20px;
        }

        .content {
          padding: 20px;
        }

        .table {
          font-size: 0.9em;
        }

        .table th,
        .table td {
          padding: 10px 5px;
        }

        /* Hide less important columns on mobile */
        .table th:nth-child(2),
        .table td:nth-child(2) {
          display: none;
        }

        .table th:nth-child(3),
        .table td:nth-child(3) {
          display: none;
        }

        /* Make company name column wider on mobile */
        .table th:first-child,
        .table td:first-child {
          min-width: 150px;
          max-width: 200px;
        }
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>💰 Investment Portfolio Tracker</h1>
        <div style="margin-bottom: 10px">
          <span
            style="
              background: rgba(255, 255, 255, 0.2);
              padding: 8px 16px;
              border-radius: 20px;
              font-size: 0.9em;
            "
          >
            🔴 Live Market Data
          </span>
        </div>
        <div class="last-updated" id="lastUpdated">Loading...</div>
      </div>

      <!-- Data Sources Section -->
      <div
        style="
          background: #f8f9fa;
          padding: 20px;
          border-left: 4px solid #4caf50;
          margin: 20px;
          border-radius: 8px;
        "
      >
        <h3 style="margin-bottom: 10px; color: #333; font-size: 1.1em">
          📊 Data Sources
        </h3>
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            font-size: 0.9em;
          "
        >
          <div>
            <strong style="color: #2196f3">📈 Stock Market Data:</strong>
            <div style="margin-top: 5px; color: #666">
              <a
                href="https://finance.yahoo.com"
                target="_blank"
                style="color: #2196f3; text-decoration: none"
              >
                🔗 Yahoo Finance
              </a>
              <div style="font-size: 0.8em; margin-top: 2px">
                Real-time prices for global exchanges (NSE, BSE, NASDAQ, NYSE,
                etc.)
              </div>
            </div>
          </div>
          <div>
            <strong style="color: #ff9800">📊 Mutual Fund Data:</strong>
            <div
              style="
                margin-top: 3px;
                font-size: 0.85em;
                color: #d32f2f;
                font-weight: bold;
              "
            >
              **Mutual Fund tracking is only for India**
            </div>
            <div style="margin-top: 5px; color: #666">
              <a
                href="https://mfapi.in"
                target="_blank"
                style="color: #ff9800; text-decoration: none"
              >
                🔗 MFAPI.in (AMFI Data)
              </a>
              <div style="font-size: 0.8em; margin-top: 2px">
                Daily NAV updates from Association of Mutual Funds in India
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="summary" id="summary">
        <!-- Summary cards will be populated by JavaScript -->
      </div>

      <!-- Global Refresh Section -->
      <div style="text-align: center; padding: 20px; background: #f8f9fa">
        <button
          class="btn btn-refresh"
          onclick="refreshPortfolio()"
          style="font-size: 1.1em; padding: 15px 30px"
          title="Refresh all prices and NAV with live market data from Yahoo Finance & MFAPI.in"
        >
          <span id="globalRefreshIcon">🔄</span> Refresh All Prices & NAV
        </button>
        <div style="margin-top: 10px; color: #666; font-size: 0.9em">
          Click to fetch latest market prices and mutual fund NAV<br />
          <small style="color: #888"
            >Sources: Yahoo Finance (stocks) • MFAPI.in (mutual funds)</small
          >
        </div>
      </div>

      <div class="content">
        <!-- Stocks Section -->
        <div class="section">
          <div class="section-header">
            <h2>📈 Stocks</h2>
            <div>
              <button class="btn" onclick="toggleStockForm()">Add Stock</button>
            </div>
          </div>

          <!-- Add Stock Form -->
          <div class="form-container" id="stockForm" style="display: none">
            <h3>Add New Stock</h3>
            <form onsubmit="addStock(event)">
              <div class="form-grid">
                <div class="form-group">
                  <label for="stockExchange">Stock Exchange</label>
                  <select
                    id="stockExchange"
                    required
                    onchange="updateStockSymbolPlaceholder()"
                  >
                    <option value="">Select Exchange</option>
                    <option value="NSE">NSE (India)</option>
                    <option value="BSE">BSE (India)</option>
                    <option value="NASDAQ">NASDAQ (US)</option>
                    <option value="NYSE">NYSE (US)</option>
                    <option value="LSE">LSE (UK)</option>
                    <option value="TSE">TSE (Japan)</option>
                    <option value="SSE">SSE (China)</option>
                    <option value="ASX">ASX (Australia)</option>
                    <option value="TSX">TSX (Canada)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="stockSymbol">Stock Symbol</label>
                  <div class="input-with-icon">
                    <input
                      type="text"
                      id="stockSymbol"
                      placeholder="Select exchange first"
                      required
                      autocomplete="off"
                      oninput="searchStocks(this.value)"
                    />
                    <span class="search-icon">🔍</span>
                    <div
                      id="stockSuggestions"
                      class="suggestions-dropdown"
                    ></div>
                  </div>
                  <div
                    id="stockSymbolError"
                    style="
                      color: #e74c3c;
                      font-size: 0.8em;
                      display: none;
                      margin-top: 5px;
                      font-weight: bold;
                    "
                  ></div>
                </div>
                <div class="form-group">
                  <label for="stockQuantity">Quantity</label>
                  <input
                    type="number"
                    id="stockQuantity"
                    step="1"
                    placeholder="10"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="stockPrice">Purchase Price (₹)</label>
                  <input
                    type="number"
                    id="stockPrice"
                    step="0.01"
                    placeholder="2500.00"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="stockDate">Purchase Date</label>
                  <input type="date" id="stockDate" required />
                </div>
              </div>
              <button type="submit" class="btn">Add Stock</button>
              <button
                type="button"
                class="btn btn-danger"
                onclick="toggleStockForm()"
              >
                Cancel
              </button>
            </form>
          </div>

          <div id="stocksTable">
            <!-- Stocks table will be populated by JavaScript -->
          </div>
        </div>

        <!-- Mutual Funds Section -->
        <div class="section">
          <div class="section-header">
            <h2>📊 Mutual Funds</h2>
            <div>
              <button class="btn" onclick="toggleMFForm()">
                Add Mutual Fund
              </button>
            </div>
          </div>

          <!-- Add Mutual Fund Form -->
          <div class="form-container" id="mfForm" style="display: none">
            <h3>Add New Mutual Fund</h3>
            <form onsubmit="addMutualFund(event)">
              <div class="form-grid">
                <div class="form-group">
                  <label for="mfScheme">Scheme Name</label>
                  <div class="input-with-icon">
                    <input
                      type="text"
                      id="mfScheme"
                      placeholder="Search Mutual Funds"
                      required
                      oninput="searchMutualFunds(this.value)"
                    />
                    <span class="search-icon">🔍</span>
                    <div id="mfSuggestions" class="suggestions-dropdown"></div>
                  </div>
                  <div
                    id="mfSchemeError"
                    style="
                      color: #e74c3c;
                      font-size: 0.8em;
                      display: none;
                      margin-top: 5px;
                      font-weight: bold;
                    "
                  ></div>
                </div>
                <div class="form-group">
                  <label for="mfUnits">Units</label>
                  <input
                    type="number"
                    id="mfUnits"
                    step="0.001"
                    placeholder="100.500"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="mfNAV">Purchase NAV (₹)</label>
                  <input
                    type="number"
                    id="mfNAV"
                    step="0.01"
                    placeholder="50.25"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="mfAmount">Invested Amount (₹)</label>
                  <input
                    type="number"
                    id="mfAmount"
                    step="0.01"
                    placeholder="5000.00"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="mfDate">Purchase Date</label>
                  <input type="date" id="mfDate" required />
                </div>
              </div>
              <button type="submit" class="btn">Add Mutual Fund</button>
              <button
                type="button"
                class="btn btn-danger"
                onclick="toggleMFForm()"
              >
                Cancel
              </button>
            </form>
          </div>

          <div id="mfTable">
            <!-- Mutual funds table will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Transactions</h2>
          <button class="close-modal" onclick="closeTransactionModal()">
            &times;
          </button>
        </div>
        <div id="modalTransactionList" class="transaction-list">
          <!-- Transaction details will be populated here -->
        </div>
      </div>
    </div>

    <!-- Edit Mutual Fund Modal -->
    <div id="editMutualFundModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Mutual Fund Transaction</h2>
          <button class="close-modal" onclick="closeEditMutualFundModal()">
            &times;
          </button>
        </div>
        <div class="form-container">
          <form onsubmit="updateMutualFundTransaction(event)">
            <input type="hidden" id="editMfTransactionId" />
            <div class="form-grid">
              <div class="form-group">
                <label for="editMfUnits">Units</label>
                <input
                  type="number"
                  id="editMfUnits"
                  step="0.001"
                  placeholder="100.500"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editMfNAV">Purchase NAV (₹)</label>
                <input
                  type="number"
                  id="editMfNAV"
                  step="0.01"
                  placeholder="50.25"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editMfAmount">Invested Amount (₹)</label>
                <input
                  type="number"
                  id="editMfAmount"
                  step="0.01"
                  placeholder="5000.00"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editMfDate">Purchase Date</label>
                <input type="date" id="editMfDate" required />
              </div>
            </div>
            <button type="submit" class="btn">Update Transaction</button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="closeEditMutualFundModal()"
            >
              Cancel
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Stock Modal -->
    <div id="editStockModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Stock Transaction</h2>
          <button class="close-modal" onclick="closeEditStockModal()">
            &times;
          </button>
        </div>
        <div class="form-container">
          <form onsubmit="updateStockTransaction(event)">
            <input type="hidden" id="editStockTransactionId" />
            <div class="form-grid">
              <div class="form-group">
                <label for="editStockQuantity">Quantity</label>
                <input
                  type="number"
                  id="editStockQuantity"
                  step="1"
                  placeholder="100"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editStockPrice">Purchase Price (₹)</label>
                <input
                  type="number"
                  id="editStockPrice"
                  step="0.01"
                  placeholder="2500.75"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editStockDate">Purchase Date</label>
                <input type="date" id="editStockDate" required />
              </div>
            </div>
            <button type="submit" class="btn">Update Transaction</button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="closeEditStockModal()"
            >
              Cancel
            </button>
          </form>
        </div>
      </div>

      <!-- Footer with detailed data source information -->
      <div
        style="
          background: #263238;
          color: white;
          padding: 30px;
          margin-top: 40px;
        "
      >
        <div style="max-width: 1000px; margin: 0 auto">
          <h3 style="text-align: center; margin-bottom: 20px; color: #4caf50">
            📊 Data Sources & APIs
          </h3>

          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 30px;
              margin-bottom: 20px;
            "
          >
            <div
              style="
                background: rgba(255, 255, 255, 0.1);
                padding: 20px;
                border-radius: 10px;
              "
            >
              <h4 style="color: #64b5f6; margin-bottom: 10px">
                📈 Stock Market Data
              </h4>
              <div style="margin-bottom: 10px">
                <strong>Primary Source:</strong>
                <a
                  href="https://finance.yahoo.com"
                  target="_blank"
                  style="color: #81c784"
                  >Yahoo Finance API</a
                >
              </div>
              <div style="font-size: 0.9em; line-height: 1.4">
                <div>• Real-time stock prices</div>
                <div>• Company names and metadata</div>
                <div>• Global exchanges support</div>
                <div>
                  • API:
                  <code
                    style="
                      background: rgba(0, 0, 0, 0.3);
                      padding: 2px 4px;
                      border-radius: 3px;
                    "
                    >query1.finance.yahoo.com</code
                  >
                </div>
              </div>
              <div style="margin-top: 10px; font-size: 0.8em; color: #b0bec5">
                <strong>Supported Exchanges:</strong> NSE, BSE, NASDAQ, NYSE,
                LSE, TSE, SSE, ASX, TSX
              </div>
            </div>

            <div
              style="
                background: rgba(255, 255, 255, 0.1);
                padding: 20px;
                border-radius: 10px;
              "
            >
              <h4 style="color: #ffb74d; margin-bottom: 10px">
                📊 Mutual Fund Data
              </h4>
              <div style="margin-bottom: 10px">
                <strong>Primary Source:</strong>
                <a
                  href="https://api.mfapi.in"
                  target="_blank"
                  style="color: #81c784"
                  >MFAPI.in</a
                >
              </div>
              <div style="font-size: 0.9em; line-height: 1.4">
                <div>• Daily NAV updates</div>
                <div>• AMFI registered schemes</div>
                <div>• Historical NAV data</div>
                <div>
                  • API:
                  <code
                    style="
                      background: rgba(0, 0, 0, 0.3);
                      padding: 2px 4px;
                      border-radius: 3px;
                    "
                    >api.mfapi.in/mf/{code}</code
                  >
                </div>
              </div>
              <div style="margin-top: 10px; font-size: 0.8em; color: #b0bec5">
                <strong>Data Authority:</strong> Association of Mutual Funds in
                India (AMFI)
              </div>
            </div>
          </div>

          <div
            style="
              text-align: center;
              padding-top: 15px;
              border-top: 1px solid rgba(255, 255, 255, 0.2);
            "
          >
            <div style="font-size: 0.9em; color: #b0bec5">
              <div style="margin-bottom: 5px">
                ⚡ Real-time data updates • 🔒 Secure API connections • 📱
                Responsive design
              </div>
              <div style="font-size: 0.8em">
                Portfolio data stored locally • Market data refreshed on demand
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let portfolio = { stocks: [], mutualFunds: [], lastUpdated: null };
      let consolidatedPortfolio = {
        stocks: [],
        mutualFunds: [],
        lastUpdated: null,
      };

      // Load portfolio data
      async function loadPortfolio() {
        try {
          console.log("Starting to load portfolio...");
          // Load both regular and consolidated data
          const [regularResponse, consolidatedResponse] = await Promise.all([
            fetch("/api/portfolio"),
            fetch("/api/portfolio/consolidated"),
          ]);

          console.log(
            "API responses received:",
            regularResponse.status,
            consolidatedResponse.status
          );

          if (!regularResponse.ok) {
            throw new Error(
              `Regular portfolio API failed: ${regularResponse.status}`
            );
          }
          if (!consolidatedResponse.ok) {
            throw new Error(
              `Consolidated portfolio API failed: ${consolidatedResponse.status}`
            );
          }

          portfolio = await regularResponse.json();
          consolidatedPortfolio = await consolidatedResponse.json();
          console.log(
            "Portfolio data loaded:",
            portfolio,
            consolidatedPortfolio
          );
          updateUI();
          console.log("UI updated successfully");
        } catch (error) {
          console.error("Error loading portfolio:", error);
          throw error; // Re-throw so the calling function can handle it
        }
      }

      // Update UI with portfolio data
      function updateUI() {
        updateSummary();
        updateStocksTable();
        updateMutualFundsTable();
        updateLastUpdated();
      }

      // Toggle stocks view between consolidated and detailed
      function toggleStocksView(mode) {
        stocksViewMode = mode;

        // Update button states
        document
          .getElementById("stocksConsolidatedBtn")
          .classList.toggle("active", mode === "consolidated");
        document
          .getElementById("stocksDetailedBtn")
          .classList.toggle("active", mode === "detailed");

        updateStocksTable();
      }

      // Toggle mutual funds view between consolidated and detailed
      function toggleMFView(mode) {
        mfViewMode = mode;

        // Update button states
        document
          .getElementById("mfConsolidatedBtn")
          .classList.toggle("active", mode === "consolidated");
        document
          .getElementById("mfDetailedBtn")
          .classList.toggle("active", mode === "detailed");

        updateMutualFundsTable();
      }

      // Update summary cards
      function updateSummary() {
        const stocksInvested = calculateStocksInvested() || 0;
        const stocksCurrentValue = calculateStocksCurrentValue() || 0;
        const stocksGain = stocksCurrentValue - stocksInvested;
        const stocksGainPercent =
          stocksInvested > 0 ? (stocksGain / stocksInvested) * 100 : 0;

        const mfInvested = calculateMutualFundsInvested() || 0;
        const mfCurrentValue = calculateMutualFundsCurrentValue() || 0;
        const mfGain = mfCurrentValue - mfInvested;
        const mfGainPercent = mfInvested > 0 ? (mfGain / mfInvested) * 100 : 0;

        const totalInvested = stocksInvested + mfInvested;
        const currentValue = stocksCurrentValue + mfCurrentValue;
        const totalGain = currentValue - totalInvested;
        const gainPercent =
          totalInvested > 0 ? (totalGain / totalInvested) * 100 : 0;

        // Ensure all values are numbers
        const safeStocksInvested = isNaN(stocksInvested) ? 0 : stocksInvested;
        const safeStocksCurrentValue = isNaN(stocksCurrentValue)
          ? 0
          : stocksCurrentValue;
        const safeStocksGain = isNaN(stocksGain) ? 0 : stocksGain;
        const safeStocksGainPercent = isNaN(stocksGainPercent)
          ? 0
          : stocksGainPercent;

        const safeMfInvested = isNaN(mfInvested) ? 0 : mfInvested;
        const safeMfCurrentValue = isNaN(mfCurrentValue) ? 0 : mfCurrentValue;
        const safeMfGain = isNaN(mfGain) ? 0 : mfGain;
        const safeMfGainPercent = isNaN(mfGainPercent) ? 0 : mfGainPercent;

        const safeTotalInvested = isNaN(totalInvested) ? 0 : totalInvested;
        const safeCurrentValue = isNaN(currentValue) ? 0 : currentValue;
        const safeTotalGain = isNaN(totalGain) ? 0 : totalGain;
        const safeGainPercent = isNaN(gainPercent) ? 0 : gainPercent;

        const summaryHTML = `
                <div class="summary-card">
                    <h3>📈 Stocks Investment</h3>
                    <div class="value">₹${safeStocksCurrentValue.toLocaleString(
                      "en-IN",
                      { maximumFractionDigits: 2 }
                    )}</div>
                    <div class="gain-loss ${
                      safeStocksGain >= 0 ? "positive" : "negative"
                    }">
                        ${
                          safeStocksGain >= 0 ? "+" : ""
                        }₹${safeStocksGain.toLocaleString("en-IN", {
          maximumFractionDigits: 2,
        })} (${
          safeStocksGainPercent >= 0 ? "+" : ""
        }${safeStocksGainPercent.toFixed(2)}%)
                    </div>
                    <div class="invested-amount">Invested: ₹${safeStocksInvested.toLocaleString(
                      "en-IN",
                      { maximumFractionDigits: 2 }
                    )}</div>
                </div>
                <div class="summary-card">
                    <h3>📊 Mutual Funds Investment</h3>
                    <div class="value">₹${safeMfCurrentValue.toLocaleString(
                      "en-IN",
                      {
                        maximumFractionDigits: 2,
                      }
                    )}</div>
                    <div class="gain-loss ${
                      safeMfGain >= 0 ? "positive" : "negative"
                    }">
                        ${
                          safeMfGain >= 0 ? "+" : ""
                        }₹${safeMfGain.toLocaleString("en-IN", {
          maximumFractionDigits: 2,
        })} (${safeMfGainPercent >= 0 ? "+" : ""}${safeMfGainPercent.toFixed(
          2
        )}%)
                    </div>
                    <div class="invested-amount">Invested: ₹${safeMfInvested.toLocaleString(
                      "en-IN",
                      {
                        maximumFractionDigits: 2,
                      }
                    )}</div>
                </div>
                <div class="summary-card">
                    <h3>💰 Total Portfolio</h3>
                    <div class="value">₹${safeCurrentValue.toLocaleString(
                      "en-IN",
                      {
                        maximumFractionDigits: 2,
                      }
                    )}</div>
                    <div class="gain-loss ${
                      safeTotalGain >= 0 ? "positive" : "negative"
                    }">
                        ${
                          safeTotalGain >= 0 ? "+" : ""
                        }₹${safeTotalGain.toLocaleString("en-IN", {
          maximumFractionDigits: 2,
        })} (${safeGainPercent >= 0 ? "+" : ""}${safeGainPercent.toFixed(2)}%)
                    </div>
                    <div class="invested-amount">Invested: ₹${safeTotalInvested.toLocaleString(
                      "en-IN",
                      { maximumFractionDigits: 2 }
                    )}</div>
                </div>
                <div class="summary-card">
                    <h3>📋 Portfolio Summary</h3>
                    <!-- Updated: Combined display with percentages -->
                    <div class="value">${
                      (consolidatedPortfolio && consolidatedPortfolio.stocks
                        ? consolidatedPortfolio.stocks.length
                        : 0) +
                      (consolidatedPortfolio &&
                      consolidatedPortfolio.mutualFunds
                        ? consolidatedPortfolio.mutualFunds.length
                        : 0)
                    }</div>
                    <ul style="list-style: none; padding: 0; margin: 10px 0; text-align: left;">
                        <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            <span style="display: flex; align-items: center;">
                                <span style="width: 8px; height: 8px; background: #2196F3; border-radius: 50%; margin-right: 10px;"></span>
                                Stocks
                            </span>
                            <span style="font-weight: 600; color: #2196F3;">
                                ${
                                  consolidatedPortfolio &&
                                  consolidatedPortfolio.stocks
                                    ? consolidatedPortfolio.stocks.length
                                    : 0
                                } (${
          consolidatedPortfolio &&
          consolidatedPortfolio.stocks &&
          consolidatedPortfolio.mutualFunds &&
          consolidatedPortfolio.stocks.length +
            consolidatedPortfolio.mutualFunds.length >
            0
            ? (
                (consolidatedPortfolio.stocks.length /
                  (consolidatedPortfolio.stocks.length +
                    consolidatedPortfolio.mutualFunds.length)) *
                100
              ).toFixed(1)
            : "0"
        }%)
                            </span>
                        </li>
                        <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="display: flex; align-items: center;">
                                <span style="width: 8px; height: 8px; background: #FF9800; border-radius: 50%; margin-right: 10px;"></span>
                                Mutual Funds
                            </span>
                            <span style="font-weight: 600; color: #FF9800;">
                                ${
                                  consolidatedPortfolio &&
                                  consolidatedPortfolio.mutualFunds
                                    ? consolidatedPortfolio.mutualFunds.length
                                    : 0
                                } (${
          consolidatedPortfolio &&
          consolidatedPortfolio.stocks &&
          consolidatedPortfolio.mutualFunds &&
          consolidatedPortfolio.stocks.length +
            consolidatedPortfolio.mutualFunds.length >
            0
            ? (
                (consolidatedPortfolio.mutualFunds.length /
                  (consolidatedPortfolio.stocks.length +
                    consolidatedPortfolio.mutualFunds.length)) *
                100
              ).toFixed(1)
            : "0"
        }%)
                            </span>
                        </li>
                    </ul>
                </div>
            `;
        document.getElementById("summary").innerHTML = summaryHTML;
      }

      // Calculate stocks invested amount (using consolidated data)
      function calculateStocksInvested() {
        if (!consolidatedPortfolio || !consolidatedPortfolio.stocks) return 0;
        return consolidatedPortfolio.stocks.reduce((sum, stock) => {
          const quantity = isNaN(stock.quantity) ? 0 : stock.quantity;
          const purchasePrice = isNaN(stock.purchasePrice)
            ? 0
            : stock.purchasePrice;
          return sum + quantity * purchasePrice;
        }, 0);
      }

      // Calculate stocks current value (using consolidated data)
      function calculateStocksCurrentValue() {
        if (!consolidatedPortfolio || !consolidatedPortfolio.stocks) return 0;
        return consolidatedPortfolio.stocks.reduce((sum, stock) => {
          const totalValue = isNaN(stock.totalValue) ? 0 : stock.totalValue;
          return sum + totalValue;
        }, 0);
      }

      // Calculate mutual funds invested amount (using consolidated data)
      function calculateMutualFundsInvested() {
        if (!consolidatedPortfolio || !consolidatedPortfolio.mutualFunds)
          return 0;
        return consolidatedPortfolio.mutualFunds.reduce((sum, mf) => {
          const investedAmount = isNaN(mf.investedAmount)
            ? 0
            : mf.investedAmount;
          return sum + investedAmount;
        }, 0);
      }

      // Calculate mutual funds current value (using consolidated data)
      function calculateMutualFundsCurrentValue() {
        if (!consolidatedPortfolio || !consolidatedPortfolio.mutualFunds)
          return 0;
        return consolidatedPortfolio.mutualFunds.reduce((sum, mf) => {
          const totalValue = isNaN(mf.totalValue) ? 0 : mf.totalValue;
          return sum + totalValue;
        }, 0);
      }

      // Calculate total invested amount (legacy function for compatibility)
      function calculateTotalInvested() {
        return calculateStocksInvested() + calculateMutualFundsInvested();
      }

      // Calculate current portfolio value (legacy function for compatibility)
      function calculateCurrentValue() {
        return (
          calculateStocksCurrentValue() + calculateMutualFundsCurrentValue()
        );
      }

      // Update stocks table
      function updateStocksTable() {
        const container = document.getElementById("stocksTable");

        if (consolidatedPortfolio.stocks.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3em;">📈</div>
                        <h3>No stocks added yet</h3>
                        <p>Add your first stock to start tracking your portfolio</p>
                    </div>
                `;
          return;
        }

        const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Company Name</th>
                            <th>Exchange</th>
                            <th>Total Quantity</th>
                            <th>Avg Purchase Price</th>
                            <th>Current Price</th>
                            <th>Invested Amount</th>
                            <th>Total Value</th>
                            <th>Gain/Loss</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${consolidatedPortfolio.stocks
                          .map(
                            (stock, index) => `
                            <tr class="transaction-row">
                                <td>
                                    <span class="arrow-icon" id="arrow-stock-${index}" onclick="toggleTransactions('stock-${index}')">▶</span>
                                    <span class="asset-name" onclick="toggleTransactions('stock-${index}')">${
                              stock.companyName ||
                              stock.originalSymbol ||
                              stock.symbol
                            }</span>
                                </td>
                                <td>${stock.exchange || "NSE"}</td>
                                <td>${
                                  isNaN(stock.quantity) ? 0 : stock.quantity
                                }</td>
                                <td>₹${(isNaN(stock.purchasePrice)
                                  ? 0
                                  : stock.purchasePrice
                                ).toFixed(2)}</td>
                                <td>
                                    ₹${(isNaN(stock.currentPrice)
                                      ? 0
                                      : stock.currentPrice
                                    ).toFixed(2)}
                                    ${
                                      stock.priceError
                                        ? '<br><small style="color: #ff9800;">⚠️ Live data unavailable</small>'
                                        : '<br><small style="color: #4CAF50;" title="Real-time data from Yahoo Finance API">🔴 Live</small>'
                                    }
                                </td>
                                <td>₹${(isNaN(stock.investedAmount)
                                  ? 0
                                  : stock.investedAmount
                                ).toLocaleString("en-IN", {
                                  maximumFractionDigits: 2,
                                })}</td>
                                <td>₹${(isNaN(stock.totalValue)
                                  ? 0
                                  : stock.totalValue
                                ).toLocaleString("en-IN", {
                                  maximumFractionDigits: 2,
                                })}</td>
                                <td class="${
                                  (isNaN(stock.totalGain)
                                    ? 0
                                    : stock.totalGain) >= 0
                                    ? "positive"
                                    : "negative"
                                }">
                                    ₹${(isNaN(stock.totalGain)
                                      ? 0
                                      : stock.totalGain
                                    ).toLocaleString("en-IN", {
                                      maximumFractionDigits: 2,
                                    })} (${
                              (isNaN(stock.gainPercent)
                                ? 0
                                : stock.gainPercent) >= 0
                                ? "+"
                                : ""
                            }${(isNaN(stock.gainPercent)
                              ? 0
                              : stock.gainPercent
                            ).toFixed(2)}%)
                                </td>
                            </tr>
                            <tr class="transaction-details" id="details-stock-${index}">
                                <td colspan="8">
                                    <div style="padding: 10px;">
                                        <h4 style="margin-bottom: 15px; color: #2196F3;">Individual Transactions for ${
                                          stock.companyName ||
                                          stock.originalSymbol ||
                                          stock.symbol
                                        } (${
                              stock.originalSymbol || stock.symbol
                            })</h4>
                                        <table class="transactions-table">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Quantity</th>
                                                    <th>Purchase Price</th>
                                                    <th>Current Value</th>
                                                    <th>Gain/Loss</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${
                                                  stock.transactions &&
                                                  stock.transactions.length > 0
                                                    ? stock.transactions
                                                        .sort(
                                                          (a, b) =>
                                                            new Date(
                                                              b.purchaseDate
                                                            ) -
                                                            new Date(
                                                              a.purchaseDate
                                                            )
                                                        )
                                                        .map(
                                                          (txn) => `
                                                    <tr>
                                                        <td>${
                                                          txn.purchaseDate ||
                                                          "N/A"
                                                        }</td>
                                                        <td>${
                                                          txn.quantity || 0
                                                        }</td>
                                                        <td>₹${(
                                                          txn.purchasePrice || 0
                                                        ).toFixed(2)}</td>
                                                        <td>₹${(
                                                          txn.totalValue || 0
                                                        ).toLocaleString(
                                                          "en-IN",
                                                          {
                                                            maximumFractionDigits: 2,
                                                          }
                                                        )}</td>
                                                        <td class="${
                                                          (txn.totalGain ||
                                                            0) >= 0
                                                            ? "positive"
                                                            : "negative"
                                                        }">
                                                            ₹${(
                                                              txn.totalGain || 0
                                                            ).toLocaleString(
                                                              "en-IN",
                                                              {
                                                                maximumFractionDigits: 2,
                                                              }
                                                            )} 
                                                            (${
                                                              (txn.gainPercent ||
                                                                0) >= 0
                                                                ? "+"
                                                                : ""
                                                            }${(
                                                            txn.gainPercent || 0
                                                          ).toFixed(2)}%)
                                                        </td>
                                                        <td>
                                                            <button class="action-btn edit-btn" onclick="editStockTransaction('${
                                                              txn.id
                                                            }')" title="Edit Transaction">
                                                                ✏️
                                                            </button>
                                                            <button class="action-btn delete-btn" onclick="deleteStockTransaction('${
                                                              txn.id
                                                            }')" title="Delete Transaction">
                                                                🗑️
                                                            </button>
                                                        </td>
                                                    </tr>
                                                  `
                                                        )
                                                        .join("")
                                                    : '<tr><td colspan="6" style="text-align: center; color: #666;">No transaction details available</td></tr>'
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
        container.innerHTML = tableHTML;
      }

      // Update mutual funds table
      function updateMutualFundsTable() {
        const container = document.getElementById("mfTable");

        if (consolidatedPortfolio.mutualFunds.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3em;">📊</div>
                        <h3>No mutual funds added yet</h3>
                        <p>Add your first mutual fund to start tracking</p>
                    </div>
                `;
          return;
        }

        const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Scheme Name</th>
                            <th>Total Units</th>
                            <th>Avg Purchase NAV</th>
                            <th>Current NAV</th>
                            <th>Invested Amount</th>
                            <th>Current Value</th>
                            <th>Gain/Loss</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${consolidatedPortfolio.mutualFunds
                          .map(
                            (mf, index) => `
                            <tr class="transaction-row">
                                <td>
                                    <span class="arrow-icon" id="arrow-mf-${index}" onclick="toggleTransactions('mf-${index}')">▶</span>
                                    <span class="asset-name" onclick="toggleTransactions('mf-${index}')">${
                              mf.scheme
                            }</span>
                                </td>
                                <td>${(isNaN(mf.units) ? 0 : mf.units).toFixed(
                                  3
                                )}</td>
                                <td>₹${(isNaN(mf.purchaseNAV)
                                  ? 0
                                  : mf.purchaseNAV
                                ).toFixed(2)}</td>
                                <td>
                                    ₹${(isNaN(mf.currentNAV)
                                      ? 0
                                      : mf.currentNAV
                                    ).toFixed(2)}
                                    ${
                                      mf.navError
                                        ? '<br><small style="color: #ff9800;">⚠️ Live data unavailable</small>'
                                        : '<br><small style="color: #4CAF50;" title="Daily NAV from AMFI via MFAPI.in">🔴 Live</small>'
                                    }
                                    ${
                                      mf.navDate
                                        ? `<br><small style="color: #666;">As of: ${mf.navDate}</small>`
                                        : ""
                                    }
                                </td>
                                <td>₹${(isNaN(mf.investedAmount)
                                  ? 0
                                  : mf.investedAmount
                                ).toLocaleString("en-IN", {
                                  maximumFractionDigits: 2,
                                })}</td>
                                <td>₹${(isNaN(mf.totalValue)
                                  ? 0
                                  : mf.totalValue
                                ).toLocaleString("en-IN", {
                                  maximumFractionDigits: 2,
                                })}</td>
                                <td class="${
                                  (isNaN(mf.totalGain) ? 0 : mf.totalGain) >= 0
                                    ? "positive"
                                    : "negative"
                                }">
                                    ₹${(isNaN(mf.totalGain)
                                      ? 0
                                      : mf.totalGain
                                    ).toLocaleString("en-IN", {
                                      maximumFractionDigits: 2,
                                    })} (${
                              (isNaN(mf.gainPercent) ? 0 : mf.gainPercent) >= 0
                                ? "+"
                                : ""
                            }${(isNaN(mf.gainPercent)
                              ? 0
                              : mf.gainPercent
                            ).toFixed(2)}%)
                                </td>
                            </tr>
                            <tr class="transaction-details" id="details-mf-${index}">
                                <td colspan="7">
                                    <div style="padding: 10px;">
                                        <h4 style="margin-bottom: 15px; color: #2196F3;">Individual Transactions for ${
                                          mf.scheme
                                        } ${
                              mf.schemeCode ? `(${mf.schemeCode})` : ""
                            }</h4>
                                        <table class="transactions-table">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Units</th>
                                                    <th>Purchase NAV</th>
                                                    <th>Purchase Value</th>
                                                    <th>Current Value</th>
                                                    <th>Gain/Loss</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${
                                                  mf.transactions &&
                                                  mf.transactions.length > 0
                                                    ? mf.transactions
                                                        .sort(
                                                          (a, b) =>
                                                            new Date(
                                                              b.purchaseDate
                                                            ) -
                                                            new Date(
                                                              a.purchaseDate
                                                            )
                                                        )
                                                        .map(
                                                          (txn) => `
                                                    <tr>
                                                        <td>${
                                                          txn.purchaseDate ||
                                                          "N/A"
                                                        }</td>
                                                        <td>${(
                                                          txn.units || 0
                                                        ).toFixed(3)}</td>
                                                        <td>₹${(
                                                          txn.purchaseNAV || 0
                                                        ).toFixed(2)}</td>
                                                        <td>₹${(
                                                          (txn.units || 0) *
                                                          (txn.purchaseNAV || 0)
                                                        ).toLocaleString(
                                                          "en-IN",
                                                          {
                                                            maximumFractionDigits: 2,
                                                          }
                                                        )}</td>
                                                        <td>₹${(
                                                          txn.totalValue || 0
                                                        ).toLocaleString(
                                                          "en-IN",
                                                          {
                                                            maximumFractionDigits: 2,
                                                          }
                                                        )}</td>
                                                        <td class="${
                                                          (txn.totalGain ||
                                                            0) >= 0
                                                            ? "positive"
                                                            : "negative"
                                                        }">
                                                            ₹${(
                                                              txn.totalGain || 0
                                                            ).toLocaleString(
                                                              "en-IN",
                                                              {
                                                                maximumFractionDigits: 2,
                                                              }
                                                            )} 
                                                            (${
                                                              (txn.gainPercent ||
                                                                0) >= 0
                                                                ? "+"
                                                                : ""
                                                            }${(
                                                            txn.gainPercent || 0
                                                          ).toFixed(2)}%)
                                                        </td>
                                                        <td>
                                                            <button class="action-btn edit-btn" onclick="editMutualFundTransaction('${
                                                              txn.id
                                                            }')" title="Edit Transaction">
                                                                ✏️
                                                            </button>
                                                            <button class="action-btn delete-btn" onclick="deleteMutualFundTransaction('${
                                                              txn.id
                                                            }')" title="Delete Transaction">
                                                                🗑️
                                                            </button>
                                                        </td>
                                                    </tr>
                                                  `
                                                        )
                                                        .join("")
                                                    : '<tr><td colspan="6" style="text-align: center; color: #666;">No transaction details available</td></tr>'
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
        container.innerHTML = tableHTML;
      }

      // Update last updated time
      function updateLastUpdated() {
        const lastUpdatedElement = document.getElementById("lastUpdated");
        if (portfolio.lastUpdated) {
          const date = new Date(portfolio.lastUpdated);
          lastUpdatedElement.textContent = `Last refreshed: ${date.toLocaleString(
            "en-IN"
          )} • Click refresh for latest prices`;
        } else {
          lastUpdatedElement.textContent =
            "Click refresh button to fetch latest market data";
        }
      }

      // Toggle transaction details visibility
      function toggleTransactions(rowId) {
        const detailsRow = document.getElementById(`details-${rowId}`);
        const arrowIcon = document.getElementById(`arrow-${rowId}`);

        if (detailsRow.classList.contains("show")) {
          detailsRow.classList.remove("show");
          arrowIcon.classList.remove("expanded");
        } else {
          detailsRow.classList.add("show");
          arrowIcon.classList.add("expanded");
        }
      }

      // Toggle stock form
      function toggleStockForm() {
        const form = document.getElementById("stockForm");
        const isHiding = form.style.display === "block";
        form.style.display = form.style.display === "none" ? "block" : "none";

        // Reset tracking when hiding form
        if (isHiding) {
          stockSelectedFromSuggestion = false;
          hideFieldError("stockSymbolError");
        }
        // Remove auto-setting today's date - let user choose
      }

      // Toggle mutual fund form
      function toggleMFForm() {
        const form = document.getElementById("mfForm");
        const isHiding = form.style.display === "block";
        form.style.display = form.style.display === "none" ? "block" : "none";

        // Reset tracking when hiding form
        if (isHiding) {
          mutualFundSelectedFromSuggestion = false;
          hideFieldError("mfSchemeError");
        }
        // Remove auto-setting today's date - let user choose
      }

      // Update stock symbol placeholder based on selected exchange
      function updateStockSymbolPlaceholder() {
        const exchange = document.getElementById("stockExchange").value;
        const symbolInput = document.getElementById("stockSymbol");

        const exchangeInfo = {
          NSE: {
            currency: "₹",
          },
          BSE: {
            currency: "₹",
          },
          NASDAQ: {
            currency: "$",
          },
          NYSE: {
            currency: "$",
          },
          LSE: {
            currency: "£",
          },
          TSE: {
            currency: "¥",
          },
          SSE: {
            currency: "¥",
          },
          ASX: {
            currency: "A$",
          },
          TSX: {
            currency: "C$",
          },
        };

        if (exchange && exchangeInfo[exchange]) {
          symbolInput.placeholder = "Search Stocks";

          // Clear all input fields when exchange changes
          symbolInput.value = "";
          document.getElementById("stockQuantity").value = "";
          document.getElementById("stockPrice").value = "";
          document.getElementById("stockDate").value = "";

          // Reset selection tracking and hide error
          stockSelectedFromSuggestion = false;
          hideFieldError("stockSymbolError");

          // Hide any open suggestions
          const suggestionsDiv = document.getElementById("stockSuggestions");
          if (suggestionsDiv) {
            suggestionsDiv.style.display = "none";
          }

          // Update currency symbol in price label
          const priceLabel = document.querySelector('label[for="stockPrice"]');
          if (priceLabel) {
            priceLabel.textContent = `Purchase Price (${exchangeInfo[exchange].currency})`;
          }
        } else {
          symbolInput.placeholder = "Select exchange first";

          // Clear all input fields when no exchange is selected
          symbolInput.value = "";
          document.getElementById("stockQuantity").value = "";
          document.getElementById("stockPrice").value = "";
          document.getElementById("stockDate").value = "";

          // Reset selection tracking and hide error
          stockSelectedFromSuggestion = false;
          hideFieldError("stockSymbolError");

          // Hide any open suggestions
          const suggestionsDiv = document.getElementById("stockSuggestions");
          if (suggestionsDiv) {
            suggestionsDiv.style.display = "none";
          }
        }
      }

      // Stock search functionality
      let searchTimeout;

      // Variables to track if user selected from suggestions
      let stockSelectedFromSuggestion = false;
      let mutualFundSelectedFromSuggestion = false;

      // Helper functions for error messages
      function showFieldError(errorElementId, message) {
        const errorElement = document.getElementById(errorElementId);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.style.display = "block";
        }
      }

      function hideFieldError(errorElementId) {
        const errorElement = document.getElementById(errorElementId);
        if (errorElement) {
          errorElement.style.display = "none";
        }
      }

      async function searchStocks(query) {
        clearTimeout(searchTimeout);
        const suggestionsDiv = document.getElementById("stockSuggestions");
        const exchange = document.getElementById("stockExchange").value;

        // Reset selection tracking when user starts typing and hide any error
        if (query && query.length > 0) {
          stockSelectedFromSuggestion = false;
          hideFieldError("stockSymbolError");
        }

        // Don't show suggestions if no exchange is selected
        if (!exchange) {
          suggestionsDiv.style.display = "none";
          return;
        }

        if (!query || query.length < 2) {
          suggestionsDiv.style.display = "none";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            // Show loading state
            suggestionsDiv.innerHTML =
              '<div class="suggestion-item loading">Searching...</div>';
            suggestionsDiv.style.display = "block";

            // Call the stock search API
            const response = await fetch(
              `/api/stock/search?query=${encodeURIComponent(
                query
              )}&exchange=${exchange}`
            );

            if (!response.ok) {
              throw new Error("Search failed");
            }

            const stocks = await response.json();

            if (stocks.length > 0) {
              suggestionsDiv.innerHTML = stocks
                .map(
                  (stock) => `
                <div class="suggestion-item" onclick="selectStock('${
                  stock.symbol
                }', '${stock.name.replace(/'/g, "\\'")}')">
                  <div>
                    <span class="suggestion-symbol">${stock.symbol}</span>
                    <span class="suggestion-name">${stock.name}</span>
                  </div>
                  <span class="suggestion-exchange">${
                    exchange || stock.exchange
                  }</span>
                </div>
              `
                )
                .join("");
              suggestionsDiv.style.display = "block";
            } else {
              suggestionsDiv.innerHTML =
                '<div class="suggestion-item no-results">No stocks found</div>';
              suggestionsDiv.style.display = "block";
            }
          } catch (error) {
            console.error("Stock search error:", error);
            suggestionsDiv.innerHTML =
              '<div class="suggestion-item error">Search failed. Please try again.</div>';
            suggestionsDiv.style.display = "block";
          }
        }, 300);
      }

      function selectStock(symbol, name) {
        document.getElementById("stockSymbol").value = symbol;
        document.getElementById("stockSuggestions").style.display = "none";

        // Mark that user selected from suggestion
        stockSelectedFromSuggestion = true;
      }

      async function searchStocksEdit(query) {
        clearTimeout(searchTimeout);
        const suggestionsDiv = document.getElementById("editStockSuggestions");
        const exchange = document.getElementById("editStockExchange").value;

        // Don't show suggestions if no exchange is selected
        if (!exchange) {
          suggestionsDiv.style.display = "none";
          return;
        }

        if (!query || query.length < 2) {
          suggestionsDiv.style.display = "none";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            // Show loading state
            suggestionsDiv.innerHTML =
              '<div class="suggestion-item loading">Searching...</div>';
            suggestionsDiv.style.display = "block";

            // Call the stock search API
            const response = await fetch(
              `/api/stock/search?query=${encodeURIComponent(
                query
              )}&exchange=${exchange}`
            );

            if (!response.ok) {
              throw new Error("Search failed");
            }

            const stocks = await response.json();

            if (stocks.length > 0) {
              suggestionsDiv.innerHTML = stocks
                .map(
                  (stock) => `
                <div class="suggestion-item" onclick="selectStockEdit('${
                  stock.symbol
                }', '${stock.name.replace(/'/g, "\\'")}')">
                  <div>
                    <span class="suggestion-symbol">${stock.symbol}</span>
                    <span class="suggestion-name">${stock.name}</span>
                  </div>
                  <span class="suggestion-exchange">${
                    exchange || stock.exchange
                  }</span>
                </div>
              `
                )
                .join("");
              suggestionsDiv.style.display = "block";
            } else {
              suggestionsDiv.innerHTML =
                '<div class="suggestion-item no-results">No stocks found</div>';
              suggestionsDiv.style.display = "block";
            }
          } catch (error) {
            console.error("Stock search error:", error);
            suggestionsDiv.innerHTML =
              '<div class="suggestion-item error">Search failed. Please try again.</div>';
            suggestionsDiv.style.display = "block";
          }
        }, 300);
      }

      function selectStockEdit(symbol, name) {
        document.getElementById("editStockSymbol").value = symbol;
        document.getElementById("editStockSuggestions").style.display = "none";

        // Update help text with selected stock name
        const helpText = document.querySelector("#editStockModal .help-text");
        if (helpText) {
          helpText.textContent = `Selected: ${name}`;
        }
      }

      // Hide suggestions when clicking outside
      document.addEventListener("click", function (event) {
        const inputContainer = document.querySelector(".input-with-icon");
        const suggestionsDiv = document.getElementById("stockSuggestions");

        if (!inputContainer.contains(event.target)) {
          suggestionsDiv.style.display = "none";
        }
      });

      // Mutual Fund search functionality
      let mfSearchTimeout;

      async function searchMutualFunds(query) {
        clearTimeout(mfSearchTimeout);
        const suggestionsDiv = document.getElementById("mfSuggestions");

        // Reset selection tracking when user starts typing and hide any error
        if (query && query.length > 0) {
          mutualFundSelectedFromSuggestion = false;
          hideFieldError("mfSchemeError");

          // Reset all mutual fund fields when scheme name changes
          document.getElementById("mfNAV").value = "";
          document.getElementById("mfAmount").value = "";
          document.getElementById("mfUnits").value = "";
          document.getElementById("mfDate").value = "";
        }

        if (!query || query.length < 2) {
          suggestionsDiv.style.display = "none";
          return;
        }

        mfSearchTimeout = setTimeout(async () => {
          try {
            // Show loading state
            suggestionsDiv.innerHTML =
              '<div class="suggestion-item loading">Searching...</div>';
            suggestionsDiv.style.display = "block";

            // Call the mutual fund search API
            const response = await fetch(
              `/api/mutual-fund/search?query=${encodeURIComponent(query)}`
            );

            if (!response.ok) {
              throw new Error("Search failed");
            }

            const funds = await response.json();

            if (funds.length > 0) {
              suggestionsDiv.innerHTML = funds
                .map(
                  (fund) => `
                <div class="suggestion-item" onclick="selectMutualFund('${fund.schemeName.replace(
                  /'/g,
                  "\\'"
                )}', '${fund.schemeCode}')">
                  <div>
                    <span class="suggestion-symbol">${fund.schemeCode}</span>
                    <span class="suggestion-name">${fund.schemeName}</span>
                  </div>
                  <span class="suggestion-exchange">${fund.fundHouse}</span>
                </div>
              `
                )
                .join("");
              suggestionsDiv.style.display = "block";
            } else {
              suggestionsDiv.innerHTML =
                '<div class="suggestion-item no-results">No mutual funds found</div>';
              suggestionsDiv.style.display = "block";
            }
          } catch (error) {
            console.error("Mutual fund search error:", error);
            suggestionsDiv.innerHTML =
              '<div class="suggestion-item error">Search failed. Please try again.</div>';
            suggestionsDiv.style.display = "block";
          }
        }, 300);
      }

      function selectMutualFund(schemeName, schemeCode) {
        document.getElementById("mfScheme").value = schemeName;
        document.getElementById("mfSuggestions").style.display = "none";

        // Mark that user selected from suggestion
        mutualFundSelectedFromSuggestion = true;
      }

      async function searchMutualFundsEdit(query) {
        clearTimeout(mfSearchTimeout);
        const suggestionsDiv = document.getElementById("editMfSuggestions");

        if (!query || query.length < 2) {
          suggestionsDiv.style.display = "none";
          return;
        }

        mfSearchTimeout = setTimeout(async () => {
          try {
            // Show loading state
            suggestionsDiv.innerHTML =
              '<div class="suggestion-item loading">Searching...</div>';
            suggestionsDiv.style.display = "block";

            // Call the mutual fund search API
            const response = await fetch(
              `/api/mutual-fund/search?query=${encodeURIComponent(query)}`
            );

            if (!response.ok) {
              throw new Error("Search failed");
            }

            const funds = await response.json();

            if (funds.length > 0) {
              suggestionsDiv.innerHTML = funds
                .map(
                  (fund) => `
                <div class="suggestion-item" onclick="selectMutualFundEdit('${fund.schemeName.replace(
                  /'/g,
                  "\\'"
                )}', '${fund.schemeCode}')">
                  <div>
                    <span class="suggestion-symbol">${fund.schemeCode}</span>
                    <span class="suggestion-name">${fund.schemeName}</span>
                  </div>
                  <span class="suggestion-exchange">${fund.fundHouse}</span>
                </div>
              `
                )
                .join("");
              suggestionsDiv.style.display = "block";
            } else {
              suggestionsDiv.innerHTML =
                '<div class="suggestion-item no-results">No mutual funds found</div>';
              suggestionsDiv.style.display = "block";
            }
          } catch (error) {
            console.error("Mutual fund search error:", error);
            suggestionsDiv.innerHTML =
              '<div class="suggestion-item error">Search failed. Please try again.</div>';
            suggestionsDiv.style.display = "block";
          }
        }, 300);
      }

      function selectMutualFundEdit(schemeName, schemeCode) {
        document.getElementById("editMfScheme").value = schemeName;
        document.getElementById("editMfSuggestions").style.display = "none";
      }

      // Hide MF suggestions when clicking outside
      document.addEventListener("click", function (event) {
        const mfInputContainers = document.querySelectorAll(".input-with-icon");
        const mfSuggestionsDiv = document.getElementById("mfSuggestions");
        const editMfSuggestionsDiv =
          document.getElementById("editMfSuggestions");

        let clickedInsideMfInput = false;
        mfInputContainers.forEach((container) => {
          if (container.contains(event.target)) {
            clickedInsideMfInput = true;
          }
        });

        if (!clickedInsideMfInput) {
          if (mfSuggestionsDiv) mfSuggestionsDiv.style.display = "none";
          if (editMfSuggestionsDiv) editMfSuggestionsDiv.style.display = "none";
        }
      });

      // Add stock
      async function addStock(event) {
        event.preventDefault();

        const exchange = document.getElementById("stockExchange").value;
        const symbol = document.getElementById("stockSymbol").value;

        // Validate that user selected from suggestions
        if (!stockSelectedFromSuggestion) {
          showFieldError(
            "stockSymbolError",
            "Please select a stock from the suggested list. Type to search and click on a suggestion."
          );
          document.getElementById("stockSymbol").focus();
          return;
        }

        // Hide any existing error message
        hideFieldError("stockSymbolError");

        // Create the full symbol with exchange suffix
        let fullSymbol = symbol;
        switch (exchange) {
          case "NSE":
            fullSymbol = symbol + ".NS";
            break;
          case "BSE":
            fullSymbol = symbol + ".BO";
            break;
          case "LSE":
            fullSymbol = symbol + ".L";
            break;
          case "TSE":
            fullSymbol = symbol + ".T";
            break;
          case "SSE":
            fullSymbol = symbol + ".SS";
            break;
          case "ASX":
            fullSymbol = symbol + ".AX";
            break;
          case "TSX":
            fullSymbol = symbol + ".TO";
            break;
          // NASDAQ and NYSE don't need suffix
          case "NASDAQ":
          case "NYSE":
          default:
            fullSymbol = symbol;
            break;
        }

        const stockData = {
          symbol: fullSymbol,
          originalSymbol: symbol,
          exchange: exchange,
          quantity: document.getElementById("stockQuantity").value,
          purchasePrice: document.getElementById("stockPrice").value,
          purchaseDate: document.getElementById("stockDate").value,
        };

        try {
          const addButton = document.querySelector(
            '#stockForm button[type="submit"]'
          );
          const originalText = addButton.textContent;
          addButton.innerHTML = '<span class="loading"></span> Adding Stock...';
          addButton.disabled = true;

          console.log("Sending stock data:", stockData);
          const response = await fetch("/api/portfolio/stock", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(stockData),
          });

          console.log("Response status:", response.status, response.ok);

          if (response.ok) {
            const result = await response.json();
            console.log("Stock added successfully:", result);
            document.querySelector("#stockForm form").reset();

            // Reset tracking variable and hide error
            stockSelectedFromSuggestion = false;
            hideFieldError("stockSymbolError");

            toggleStockForm();

            // Show success message immediately
            alert(
              `Stock added successfully: ${
                result.stock.companyName || result.stock.originalSymbol
              }`
            );

            // Try to refresh portfolio, but don't fail if it doesn't work
            try {
              console.log("Loading portfolio...");
              await loadPortfolio();
              console.log("Portfolio loaded successfully");
            } catch (loadError) {
              console.warn(
                "Portfolio loading failed, but stock was added. Refreshing page...",
                loadError
              );
              // If portfolio loading fails, just reload the page
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            }
          } else {
            const errorText = await response.text();
            console.error("Server error:", response.status, errorText);
            alert(`Error adding stock: ${response.status}`);
          }
        } catch (error) {
          console.error("Error adding stock:", error);
          alert(`Error adding stock: ${error.message}`);
        } finally {
          const addButton = document.querySelector(
            '#stockForm button[type="submit"]'
          );
          addButton.innerHTML = "Add Stock";
          addButton.disabled = false;
        }
      }

      // Add mutual fund
      async function addMutualFund(event) {
        event.preventDefault();

        // Validate that user selected from suggestions
        if (!mutualFundSelectedFromSuggestion) {
          showFieldError(
            "mfSchemeError",
            "Please select a mutual fund from the suggested list. Type to search and click on a suggestion."
          );
          document.getElementById("mfScheme").focus();
          return;
        }

        // Hide any existing error message
        hideFieldError("mfSchemeError");

        const mfData = {
          scheme: document.getElementById("mfScheme").value,
          units: document.getElementById("mfUnits").value,
          purchaseNAV: document.getElementById("mfNAV").value,
          investedAmount: document.getElementById("mfAmount").value,
          purchaseDate: document.getElementById("mfDate").value,
        };

        try {
          const addButton = document.querySelector(
            '#mfForm button[type="submit"]'
          );
          const originalText = addButton.textContent;
          addButton.innerHTML = '<span class="loading"></span> Adding Fund...';
          addButton.disabled = true;

          const response = await fetch("/api/portfolio/mutual-fund", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(mfData),
          });

          if (response.ok) {
            const result = await response.json();
            document.querySelector("#mfForm form").reset();

            // Reset tracking variable and hide error
            mutualFundSelectedFromSuggestion = false;
            hideFieldError("mfSchemeError");

            toggleMFForm();
            loadPortfolio();
            alert(
              `Mutual fund added successfully: ${result.mutualFund.scheme}`
            );
          } else {
            alert("Error adding mutual fund");
          }
        } catch (error) {
          console.error("Error adding mutual fund:", error);
          alert("Error adding mutual fund");
        } finally {
          const addButton = document.querySelector(
            '#mfForm button[type="submit"]'
          );
          addButton.innerHTML = "Add Mutual Fund";
          addButton.disabled = false;
        }
      }

      // Delete stock
      async function deleteStock(id) {
        if (!confirm("Are you sure you want to delete this stock?")) return;

        try {
          const response = await fetch(`/api/stocks/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            loadPortfolio();
          } else {
            alert("Error deleting stock");
          }
        } catch (error) {
          console.error("Error deleting stock:", error);
          alert("Error deleting stock");
        }
      }

      // Delete mutual fund
      async function deleteMutualFund(id) {
        if (!confirm("Are you sure you want to delete this mutual fund?"))
          return;

        try {
          const response = await fetch(`/api/mutual-funds/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            loadPortfolio();
          } else {
            alert("Error deleting mutual fund");
          }
        } catch (error) {
          console.error("Error deleting mutual fund:", error);
          alert("Error deleting mutual fund");
        }
      }

      // Open transaction modal
      function openTransactionModal(identifier, type) {
        const modal = document.getElementById("transactionModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalList = document.getElementById("modalTransactionList");

        let transactions = [];
        let titleText = "";

        if (type === "stock") {
          const stock = consolidatedPortfolio.stocks.find(
            (s) => s.symbol === identifier
          );
          if (stock) {
            transactions = stock.transactions;
            titleText = `${stock.symbol} - Stock Transactions`;
          }
        } else if (type === "mf") {
          const mf = consolidatedPortfolio.mutualFunds.find(
            (m) => m.scheme === identifier
          );
          if (mf) {
            transactions = mf.transactions;
            titleText = `${mf.scheme} - Mutual Fund Transactions`;
          }
        }

        modalTitle.textContent = titleText;

        if (transactions.length === 0) {
          modalList.innerHTML = "<p>No transactions found.</p>";
        } else {
          modalList.innerHTML = transactions
            .map((txn, idx) => {
              if (type === "stock") {
                return `
                            <div class="transaction-card">
                                <h4>Transaction ${idx + 1} - ${new Date(
                  txn.purchaseDate
                ).toLocaleDateString()}</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                    <div><strong>Quantity:</strong> ${
                                      txn.quantity
                                    }</div>
                                    <div><strong>Purchase Price:</strong> ₹${txn.purchasePrice.toFixed(
                                      2
                                    )}</div>
                                    <div><strong>Total Investment:</strong> ₹${(
                                      txn.quantity * txn.purchasePrice
                                    ).toFixed(2)}</div>
                                    <div><strong>Current Value:</strong> ₹${txn.totalValue.toFixed(
                                      2
                                    )}</div>
                                    <div><strong>Gain/Loss:</strong> <span class="${
                                      txn.totalGain >= 0
                                        ? "positive"
                                        : "negative"
                                    }">₹${txn.totalGain.toFixed(
                  2
                )} (${txn.gainPercent.toFixed(2)}%)</span></div>
                                </div>
                                <button class="btn btn-danger" onclick="deleteStock('${
                                  txn.id
                                }'); closeTransactionModal(); loadPortfolio();">Delete Transaction</button>
                            </div>
                        `;
              } else {
                return `
                            <div class="transaction-card">
                                <h4>Transaction ${idx + 1} - ${new Date(
                  txn.purchaseDate
                ).toLocaleDateString()}</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                    <div><strong>Units:</strong> ${txn.units.toFixed(
                                      3
                                    )}</div>
                                    <div><strong>Purchase NAV:</strong> ₹${txn.purchaseNAV.toFixed(
                                      2
                                    )}</div>
                                    <div><strong>Invested Amount:</strong> ₹${txn.investedAmount.toFixed(
                                      2
                                    )}</div>
                                    <div><strong>Current Value:</strong> ₹${txn.totalValue.toFixed(
                                      2
                                    )}</div>
                                    <div><strong>Gain/Loss:</strong> <span class="${
                                      txn.totalGain >= 0
                                        ? "positive"
                                        : "negative"
                                    }">₹${txn.totalGain.toFixed(
                  2
                )} (${txn.gainPercent.toFixed(2)}%)</span></div>
                                </div>
                                <button class="btn btn-danger" onclick="deleteMutualFund('${
                                  txn.id
                                }'); closeTransactionModal(); loadPortfolio();">Delete Transaction</button>
                            </div>
                        `;
              }
            })
            .join("");
        }

        modal.style.display = "block";
      }

      // Close transaction modal
      function closeTransactionModal() {
        const modal = document.getElementById("transactionModal");
        modal.style.display = "none";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const transactionModal = document.getElementById("transactionModal");
        const editMutualFundModal = document.getElementById(
          "editMutualFundModal"
        );
        const editStockModal = document.getElementById("editStockModal");

        if (event.target === transactionModal) {
          closeTransactionModal();
        }

        if (event.target === editMutualFundModal) {
          closeEditMutualFundModal();
        }

        if (event.target === editStockModal) {
          closeEditStockModal();
        }
      };

      // Refresh portfolio
      async function refreshPortfolio() {
        const refreshIcon = document.getElementById("refreshIcon");
        const refreshIcon2 = document.getElementById("refreshIcon2");
        const globalRefreshIcon = document.getElementById("globalRefreshIcon");

        // Show loading state for all refresh buttons
        if (refreshIcon) refreshIcon.innerHTML = '<div class="loading"></div>';
        if (refreshIcon2)
          refreshIcon2.innerHTML = '<div class="loading"></div>';
        if (globalRefreshIcon)
          globalRefreshIcon.innerHTML = '<div class="loading"></div>';

        try {
          const response = await fetch("/api/refresh", { method: "POST" });
          if (response.ok) {
            // Reload both portfolios after refresh
            await loadPortfolio();

            // Show success message
            const message = document.createElement("div");
            message.style.cssText =
              "position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px 20px; border-radius: 8px; z-index: 1000; font-weight: bold;";
            message.textContent = "✅ Portfolio updated with latest prices!";
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
          } else {
            alert("Error refreshing portfolio");
          }
        } catch (error) {
          console.error("Error refreshing portfolio:", error);
          alert("Error refreshing portfolio");
        } finally {
          // Reset all refresh icons
          if (refreshIcon) refreshIcon.innerHTML = "🔄";
          if (refreshIcon2) refreshIcon2.innerHTML = "🔄";
          if (globalRefreshIcon) globalRefreshIcon.innerHTML = "🔄";
        }
      }

      // Edit stock transaction
      async function editStockTransaction(transactionId) {
        try {
          // Find the transaction in the portfolio data
          const transaction = portfolio.stocks.find(
            (stock) => stock.id === transactionId
          );

          if (!transaction) {
            alert("Transaction not found!");
            return;
          }

          // Populate the edit form with current values
          document.getElementById("editStockTransactionId").value =
            transactionId;
          document.getElementById("editStockQuantity").value =
            transaction.quantity;
          document.getElementById("editStockPrice").value =
            transaction.purchasePrice;
          document.getElementById("editStockDate").value =
            transaction.purchaseDate;

          // Show the edit modal
          document.getElementById("editStockModal").style.display = "block";
        } catch (error) {
          console.error("Error preparing edit form:", error);
          alert("Error loading transaction data");
        }
      }

      // Update stock transaction
      async function updateStockTransaction(event) {
        event.preventDefault();

        const transactionId = document.getElementById(
          "editStockTransactionId"
        ).value;

        // Find the existing transaction to preserve symbol and exchange
        const existingTransaction = portfolio.stocks.find(
          (stock) => stock.id === transactionId
        );

        if (!existingTransaction) {
          alert("Transaction not found!");
          return;
        }

        const quantity = parseInt(
          document.getElementById("editStockQuantity").value
        );
        const purchasePrice = parseFloat(
          document.getElementById("editStockPrice").value
        );
        const purchaseDate = document.getElementById("editStockDate").value;

        try {
          const response = await fetch(
            `/api/stocks/transaction/${transactionId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                // Preserve original symbol and exchange data
                symbol: existingTransaction.symbol,
                originalSymbol: existingTransaction.originalSymbol,
                exchange: existingTransaction.exchange,
                // Update only the editable fields
                quantity,
                purchasePrice,
                purchaseDate,
              }),
            }
          );

          if (response.ok) {
            await loadPortfolio();
            closeEditStockModal();
            alert("Stock transaction updated successfully!");
          } else {
            const errorData = await response.json();
            alert(
              `Error updating transaction: ${
                errorData.error || "Unknown error"
              }`
            );
          }
        } catch (error) {
          console.error("Error updating stock transaction:", error);
          alert("Error updating stock transaction");
        }
      }

      // Close edit stock modal
      function closeEditStockModal() {
        document.getElementById("editStockModal").style.display = "none";
        // Reset form
        document.getElementById("editStockTransactionId").value = "";
        document.getElementById("editStockQuantity").value = "";
        document.getElementById("editStockPrice").value = "";
        document.getElementById("editStockDate").value = "";
      }

      // Delete stock transaction
      async function deleteStockTransaction(transactionId) {
        if (
          confirm("Are you sure you want to delete this stock transaction?")
        ) {
          try {
            const response = await fetch(
              `/api/stocks/transaction/${transactionId}`,
              {
                method: "DELETE",
              }
            );

            if (response.ok) {
              await loadPortfolio();
              alert("Stock transaction deleted successfully!");
            } else {
              alert("Error deleting stock transaction");
            }
          } catch (error) {
            console.error("Error deleting stock transaction:", error);
            alert("Error deleting stock transaction");
          }
        }
      }

      // Edit mutual fund transaction
      async function editMutualFundTransaction(transactionId) {
        try {
          // Find the transaction in the portfolio data
          const transaction = portfolio.mutualFunds.find(
            (mf) => mf.id === transactionId
          );

          if (!transaction) {
            alert("Transaction not found!");
            return;
          }

          // Populate the edit form with current values
          document.getElementById("editMfTransactionId").value = transactionId;
          document.getElementById("editMfUnits").value = transaction.units;
          document.getElementById("editMfNAV").value = transaction.purchaseNAV;
          document.getElementById("editMfAmount").value =
            transaction.investedAmount;
          document.getElementById("editMfDate").value =
            transaction.purchaseDate;

          // Show the edit modal
          document.getElementById("editMutualFundModal").style.display =
            "block";
        } catch (error) {
          console.error("Error preparing edit form:", error);
          alert("Error loading transaction data");
        }
      }

      // Update mutual fund transaction
      async function updateMutualFundTransaction(event) {
        event.preventDefault();

        const transactionId = document.getElementById(
          "editMfTransactionId"
        ).value;

        // Find the existing transaction to preserve scheme data
        const existingTransaction = portfolio.mutualFunds.find(
          (mf) => mf.id === transactionId
        );

        if (!existingTransaction) {
          alert("Transaction not found!");
          return;
        }

        const units = parseFloat(document.getElementById("editMfUnits").value);
        const purchaseNAV = parseFloat(
          document.getElementById("editMfNAV").value
        );
        const investedAmount = parseFloat(
          document.getElementById("editMfAmount").value
        );
        const purchaseDate = document.getElementById("editMfDate").value;

        try {
          const response = await fetch(
            `/api/mutual-funds/transaction/${transactionId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                // Preserve original scheme data
                scheme: existingTransaction.scheme,
                // Update only the editable fields
                units,
                purchaseNAV,
                investedAmount,
                purchaseDate,
              }),
            }
          );

          if (response.ok) {
            await loadPortfolio();
            closeEditMutualFundModal();
            alert("Mutual fund transaction updated successfully!");
          } else {
            const errorData = await response.json();
            alert(
              `Error updating transaction: ${
                errorData.error || "Unknown error"
              }`
            );
          }
        } catch (error) {
          console.error("Error updating mutual fund transaction:", error);
          alert("Error updating mutual fund transaction");
        }
      }

      // Close edit mutual fund modal
      function closeEditMutualFundModal() {
        document.getElementById("editMutualFundModal").style.display = "none";
        // Reset form
        document.getElementById("editMfTransactionId").value = "";
        document.getElementById("editMfUnits").value = "";
        document.getElementById("editMfNAV").value = "";
        document.getElementById("editMfAmount").value = "";
        document.getElementById("editMfDate").value = "";
      }

      // Delete mutual fund transaction
      async function deleteMutualFundTransaction(transactionId) {
        if (
          confirm(
            "Are you sure you want to delete this mutual fund transaction?"
          )
        ) {
          try {
            const response = await fetch(
              `/api/mutual-funds/transaction/${transactionId}`,
              {
                method: "DELETE",
              }
            );

            if (response.ok) {
              await loadPortfolio();
              alert("Mutual fund transaction deleted successfully!");
            } else {
              alert("Error deleting mutual fund transaction");
            }
          } catch (error) {
            console.error("Error deleting mutual fund transaction:", error);
            alert("Error deleting mutual fund transaction");
          }
        }
      }

      // Initialize app
      window.addEventListener("load", function () {
        loadPortfolio();
        updateStockSymbolPlaceholder(); // Set initial placeholder correctly
      });
    </script>
  </body>
</html>
